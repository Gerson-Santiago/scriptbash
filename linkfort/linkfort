#!/usr/bin/env bash
set -e

# Caminhos
BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="$BASE_DIR/.venv"
VENV_ACTIVATE="$VENV_DIR/bin/activate"

echo "========================================="
echo "   LINKFORT - ORQUESTRADOR v3.4"
echo "========================================="

# 1. Check de Vers√µes (Diagn√≥stico)
echo "[1/4] Verificando vers√µes do sistema..."
PY_VERSION=$(python3 --version 2>&1 | awk '{print $2}')
PIP_VERSION=$(python3 -m pip --version 2>/dev/null | awk '{print $2}' || echo "N√£o instalado")

echo "   üêç Python: $PY_VERSION (Recomendado: 3.10+)"
echo "   üì¶ Pip:    $PIP_VERSION"

# Verificar se Python √© muito antigo (simples check de string para < 3.9)
if [[ "$PY_VERSION" == 3.6* || "$PY_VERSION" == 3.7* || "$PY_VERSION" == 3.8* ]]; then
    echo "   ‚ö†Ô∏è  AVISO: Seu Python ($PY_VERSION) √© antigo. Algumas bibliotecas podem falhar."
    echo "       Recomendamos atualizar para Python 3.10 ou superior."
    sleep 3
fi

echo ""

# 2. Setup Ambiente
echo "[2/4] Verificando ambiente..."

# Garante que o venv existe
if [ ! -d "$VENV_DIR" ]; then
    echo "Criando ambiente virtual..."
    python3 -m venv "$VENV_DIR" || {
        echo "‚ùå Erro ao criar ambiente virtual. Tente instalar: sudo apt install python3-venv"
        exit 1
    }
fi

# Ativa o venv
source "$VENV_ACTIVATE"

# Instala depend√™ncias se necess√°rio (flag ou verifica√ß√£o simples)
# Uma forma robusta √© checar se um pacote chave est√° instalado ou for√ßar a instala√ß√£o se requirements mudou (mas simplificando para o caso: sempre tentar instalar/atualizar rapido)
echo "Verificando depend√™ncias..."
pip install -r "$BASE_DIR/requirements.txt" > /dev/null 2>&1 || {
    echo "‚ùå Erro ao instalar depend√™ncias. Detalhes tente rodar manual: pip install -r requirements.txt"
    exit 1
}
echo "Ambiente pronto."

# Fun√ß√£o de limpeza para modo Live
cleanup() {
    echo ""
    echo "üõë Encerrando processos..."
    if [ -n "$MONITOR_PID" ]; then
        kill "$MONITOR_PID" 2>/dev/null || true
        echo "Monitor (PID $MONITOR_PID) encerrado."
    fi
    exit 0
}

# 2. L√≥gica de Execu√ß√£o

if [[ "$1" == "--live" ]]; then
    # --- MODO LIVE (Unificado) ---
    echo "[3/4] Iniciando MODO LIVE..."
    echo "      > Monitorando DNS em background..."
    echo "      > Servidor Web iniciando..."
    
    # Inicia monitor em background
    # Redireciona output para log para n√£o poluir
    chmod +x "$BASE_DIR/monitor_dados.sh"
    "$BASE_DIR/monitor_dados.sh" > monitor.log 2>&1 &
    MONITOR_PID=$!
    
    # Registra trap para matar o monitor quando o script for abortado (Ctrl+C)
    trap cleanup SIGINT SIGTERM
    
    echo "      > Monitor PID: $MONITOR_PID"
    echo "      > Acesse: http://localhost:7777"
    echo "      (Pressione Ctrl+C para parar tudo)"
    
    # Inicia servidor em foreground
    python3 "$BASE_DIR/serve.py"
    
    # Se o servidor parar, mata o monitor
    cleanup

elif [[ "$1" == "--test" ]]; then
    # --- MODO TESTE R√ÅPIDO ---
    echo "[3/4] Teste R√°pido (1 rodada)..."
    chmod +x "$BASE_DIR/monitor_dados.sh"
    "$BASE_DIR/monitor_dados.sh" --count 1

elif [[ "$1" == "--collect" && -n "$2" ]]; then
    # --- MODO COLETA ---
    echo "[3/4] Coletando dados ($2 rodadas)..."
    chmod +x "$BASE_DIR/monitor_dados.sh"
    "$BASE_DIR/monitor_dados.sh" --count "$2"

elif [[ "$1" == "--reset" || "$1" == "-r" ]]; then
    # --- MODO RESET ---
    echo "[3/4] Resetando dados..."
    rm -f "$BASE_DIR/dados_dns_linkfort.csv"
    rm -f "$BASE_DIR/dashboard.html"
    echo "‚úÖ Dados hist√≥ricos e dashboard apagados com sucesso."
    echo "   Pronto para iniciar uma nova coleta limpa."

else
    # --- MODO APENAS DASHBOARD ---
    echo "[3/4] Gerando Dashboard com dados existentes..."
    python3 "$BASE_DIR/gerar_dashboard.py"
    
    echo "========================================="
    echo "üöÄ Iniciando Servidor Web..."
    echo "========================================="
    python3 "$BASE_DIR/serve.py"
fi
