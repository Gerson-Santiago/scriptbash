#!/usr/bin/env bash
set -e

# Caminhos
BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="$BASE_DIR/.venv"
VENV_ACTIVATE="$VENV_DIR/bin/activate"

echo "========================================="
echo "   LINKFORT - ORQUESTRADOR v3.4"
echo "========================================="

# 1. Setup Ambiente
echo "[1/3] Verificando ambiente..."
if [ ! -d "$VENV_DIR" ]; then
    echo "Criando ambiente virtual..."
    python3 -m venv "$VENV_DIR"
    source "$VENV_ACTIVATE"
    echo "Instalando depend√™ncias..."
    pip install -r "$BASE_DIR/requirements.txt"
else
    source "$VENV_ACTIVATE"
fi

# Fun√ß√£o de limpeza para modo Live
cleanup() {
    echo ""
    echo "üõë Encerrando processos..."
    if [ -n "$MONITOR_PID" ]; then
        kill "$MONITOR_PID" 2>/dev/null || true
        echo "Monitor (PID $MONITOR_PID) encerrado."
    fi
    exit 0
}

# 2. L√≥gica de Execu√ß√£o

if [[ "$1" == "--live" ]]; then
    # --- MODO LIVE (Unificado) ---
    echo "[2/3] Iniciando MODO LIVE..."
    echo "      > Monitorando DNS em background..."
    echo "      > Servidor Web iniciando..."
    
    # Inicia monitor em background
    # Redireciona output para log para n√£o poluir
    chmod +x "$BASE_DIR/monitor_dados.sh"
    "$BASE_DIR/monitor_dados.sh" > monitor.log 2>&1 &
    MONITOR_PID=$!
    
    # Registra trap para matar o monitor quando o script for abortado (Ctrl+C)
    trap cleanup SIGINT SIGTERM
    
    echo "      > Monitor PID: $MONITOR_PID"
    echo "      > Acesse: http://localhost:7777"
    echo "      (Pressione Ctrl+C para parar tudo)"
    
    # Inicia servidor em foreground
    python3 "$BASE_DIR/serve.py"
    
    # Se o servidor parar, mata o monitor
    cleanup

elif [[ "$1" == "--test" ]]; then
    # --- MODO TESTE R√ÅPIDO ---
    echo "[2/3] Teste R√°pido (1 rodada)..."
    chmod +x "$BASE_DIR/monitor_dados.sh"
    "$BASE_DIR/monitor_dados.sh" --count 1

elif [[ "$1" == "--collect" && -n "$2" ]]; then
    # --- MODO COLETA ---
    echo "[2/3] Coletando dados ($2 rodadas)..."
    chmod +x "$BASE_DIR/monitor_dados.sh"
    "$BASE_DIR/monitor_dados.sh" --count "$2"

else
    # --- MODO APENAS DASHBOARD ---
    echo "[2/3] Gerando Dashboard com dados existentes..."
    python3 "$BASE_DIR/gerar_dashboard.py"
    
    echo "========================================="
    echo "üöÄ Iniciando Servidor Web..."
    echo "========================================="
    python3 "$BASE_DIR/serve.py"
fi
