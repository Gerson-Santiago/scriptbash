#!/usr/bin/env bash
set -e

# Caminhos
BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="$BASE_DIR/.venv"
VENV_ACTIVATE="$VENV_DIR/bin/activate"

echo "========================================="
echo "   LINKFORT - ORQUESTRADOR v3.4"
echo "========================================="

# 1. Check de VersÃµes (DiagnÃ³stico)
echo "[1/4] Verificando versÃµes do sistema..."
PY_VERSION=$(python3 --version 2>&1 | awk '{print $2}')
PIP_VERSION=$(python3 -m pip --version 2>/dev/null | awk '{print $2}' || echo "NÃ£o instalado")

echo "   ğŸ Python: $PY_VERSION (Recomendado: 3.10+)"
echo "   ğŸ“¦ Pip:    $PIP_VERSION"

# Verificar se Python Ã© muito antigo (simples check de string para < 3.9)
if [[ "$PY_VERSION" == 3.6* || "$PY_VERSION" == 3.7* || "$PY_VERSION" == 3.8* ]]; then
    echo "   âš ï¸  AVISO: Seu Python ($PY_VERSION) Ã© antigo. Algumas bibliotecas podem falhar."
    echo "       Recomendamos atualizar para Python 3.10 ou superior."
    sleep 3
fi

echo ""

# 2. Setup Ambiente
echo "[2/4] Verificando ambiente..."

# Garante que o venv existe
if [ ! -d "$VENV_DIR" ]; then
    echo "Criando ambiente virtual..."
    python3 -m venv "$VENV_DIR" || {
        echo "âŒ Erro ao criar ambiente virtual. Tente instalar: sudo apt install python3-venv"
        exit 1
    }
fi

# Ativa o venv
source "$VENV_ACTIVATE"

# Instala dependÃªncias se necessÃ¡rio (flag ou verificaÃ§Ã£o simples)
# Uma forma robusta Ã© checar se um pacote chave estÃ¡ instalado ou forÃ§ar a instalaÃ§Ã£o se requirements mudou (mas simplificando para o caso: sempre tentar instalar/atualizar rapido)
echo "Verificando dependÃªncias..."
pip install -r "$BASE_DIR/requirements.txt" > /dev/null 2>&1 || {
    echo "âŒ Erro ao instalar dependÃªncias. Detalhes tente rodar manual: pip install -r requirements.txt"
    exit 1
}
echo "Ambiente pronto."

# Exporta Python para sub-scripts (DRY)
export PYTHON_EXEC="$VENV_DIR/bin/python3"

# FunÃ§Ã£o de limpeza para modo Live
cleanup() {
    echo ""
    echo "ğŸ›‘ Encerrando processos..."
    if [ -n "$MONITOR_PID" ]; then
        kill "$MONITOR_PID" 2>/dev/null || true
        echo "Monitor (PID $MONITOR_PID) encerrado."
    fi
    exit 0
}

# 2. LÃ³gica de ExecuÃ§Ã£o

if [[ "$1" == "--live" ]]; then
    # --- MODO LIVE (Unificado) ---
    echo "[3/4] Iniciando MODO LIVE..."
    echo "      > Monitorando DNS em background..."
    echo "      > Servidor Web iniciando..."
    
    # Inicia monitor em background
    # Redireciona output para log para nÃ£o poluir
    chmod +x "$BASE_DIR/monitor_dados.sh"
    "$BASE_DIR/monitor_dados.sh" > monitor.log 2>&1 &
    MONITOR_PID=$!
    
    # Registra trap para matar o monitor quando o script for abortado (Ctrl+C)
    trap cleanup SIGINT SIGTERM
    
    echo "      > Monitor PID: $MONITOR_PID"
    echo "      > Acesse: http://localhost:7777"
    echo "      (Pressione Ctrl+C para parar tudo)"
    
    # Inicia servidor em foreground
    python3 "$BASE_DIR/serve.py"
    
    # Se o servidor parar, mata o monitor
    cleanup

elif [[ "$1" == "--test" ]]; then
    # --- MODO TESTE RÃPIDO ---
    echo "[3/4] Teste RÃ¡pido (1 rodada)..."
    chmod +x "$BASE_DIR/monitor_dados.sh"
    "$BASE_DIR/monitor_dados.sh" --count 1

elif [[ "$1" == "--collect" && -n "$2" ]]; then
    # --- MODO COLETA ---
    echo "[3/4] Coletando dados ($2 rodadas)..."
    chmod +x "$BASE_DIR/monitor_dados.sh"
    "$BASE_DIR/monitor_dados.sh" --count "$2"
    
    echo "========================================="
    echo "ğŸš€ Coleta finalizada! Iniciando Servidor Web..."
    echo "========================================="
    python3 "$BASE_DIR/serve.py"

elif [[ "$1" =~ ^[0-9]+$ ]]; then
    # --- MODO COLETA (Shorthand) ---
    # CÃ¡lculo simples de estimativa: ~80s por rodada (12 IPs * 11 DomÃ­nios * 0.5s sleep + overhead)
    ESTIMATED_MIN=$(echo "$1 * 80 / 60" | bc)
    
    echo "[3/4] Coletando dados (Target: $1 rodadas)..."
    
    if [ "$1" -gt 5 ]; then
        echo "   âš ï¸  ATENÃ‡ÃƒO: Isso pode levar aprox. $ESTIMATED_MIN minutos."
        echo "   â˜• O servidor sÃ³ inicia APÃ“S o fim da coleta."
        echo "   ğŸ’¡ Dica: Para ver em tempo real, use: ./linkfort --live"
        sleep 2
    fi
    
    chmod +x "$BASE_DIR/monitor_dados.sh"
    "$BASE_DIR/monitor_dados.sh" --count "$1"
    
    # Auto-start do servidor apÃ³s coleta
    echo "========================================="
    echo "ğŸš€ Coleta finalizada! Iniciando Servidor Web..."
    echo "========================================="
    python3 "$BASE_DIR/serve.py"

elif [[ "$1" == "--reset" || "$1" == "-r" ]]; then
    # --- MODO RESET ---
    echo "[3/4] Resetando dados..."
    
    # Matar processo na porta 7777
    if command -v fuser >/dev/null 2>&1; then
        echo "      > Liberando porta 7777..."
        fuser -k 7777/tcp >/dev/null 2>&1 || true
    else
        echo "      âš ï¸  'fuser' nÃ£o encontrado. Tentando matar python3 serve.py..."
        pkill -f "serve.py" || true
    fi

    rm -f "$BASE_DIR/dados_dns_linkfort.csv"
    rm -f "$BASE_DIR/dashboard.html"
    rm -f "$BASE_DIR/dados.json"  # TambÃ©m remove o JSON
    
    echo "âœ… [RESET COMPLETO]"
    echo "   Processos encerrados e arquivos removidos:"
    echo "   ğŸ—‘ï¸  dados_dns_linkfort.csv"
    echo "   ğŸ—‘ï¸  dashboard.html"
    echo "   ğŸ—‘ï¸  dados.json"
    echo ""
    echo "   ğŸ”„ Para refazer tudo:"
    echo "      ./linkfort 50     (Recomendado)"
    echo "      ./linkfort --test (Teste rÃ¡pido)"

else
    # --- MODO APENAS DASHBOARD ---
    
    # Verifica se hÃ¡ dados antes de prosseguir
    if [ ! -f "$BASE_DIR/dados_dns_linkfort.csv" ]; then
        echo "âš ï¸  Nenhum dado encontrado para gerar dashboard."
        echo "   Execute um teste primeiro. Exemplo:"
        echo "   ./linkfort --test (Teste rÃ¡pido)"
        echo "   ./linkfort 50     (Coletar 50 rodadas)"
        exit 0
    fi
    
    echo "[3/4] Gerando Dashboard com dados existentes..."
    python3 "$BASE_DIR/gerar_dashboard.py"
    
    echo "========================================="
    echo "ğŸš€ Iniciando Servidor Web..."
    echo "========================================="
    python3 "$BASE_DIR/serve.py"
fi
